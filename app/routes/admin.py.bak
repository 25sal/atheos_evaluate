from flask import render_template, redirect, url_for, flash, request, session, make_response, send_file, Blueprint
from flask_login import login_user, LoginManager, login_required, logout_user, current_user
from werkzeug.utils import secure_filename
import os
import csv
from app.config import Config
from app.models.base import list_res_accounts, delete_res_accounts, delete_all, list_logged_accounts, list_projects
import app.models.base as model_base
from app.utils.admin import import_reservations, gen_passwords, add_atheos_users, create_random_projects, update_atheos_projects, create_prj_dirs, restrict_atheos_acl, delete_prj_dirs
# Create a permission with a single Need, in this case a RoleNeed.
from flask_principal import Permission, RoleNeed
import numpy as np


admin_role = Permission(RoleNeed('admin'))

admin_bp =  Blueprint('admin_blueprint', __name__)

@admin_bp.route('/admin', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_index():
    return render_template("admin/index.html")


@admin_bp.route('/admin/list_accounts', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def list_accounts():
    typ = request.args.get('all')
    if typ == 1:
        accounts = list_logged_accounts()
    else:
        accounts = list_res_accounts()

    content ="<?xml version='1.0' encoding='utf-8' ?><rows>";
    if accounts is not None:
        for account in accounts:
            content+="<row id='"+account[0]+"'><cell><![CDATA["+account[1]+"]]></cell><cell>" \
            "<![CDATA["+account[2]+"]]></cell><cell><![CDATA["+account[0]+"]]></cell><cell><![CDATA[]]></cell></row>"
        content +="</rows>"
    resp = make_response(content)
    resp.headers['Content-Type'] = 'application/xml'
    return resp

@admin_bp.route('/admin/list_prj_user', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def list_prj_user():
    accounts = list_res_accounts()
    content = "<?xml version='1.0' encoding='utf-8' ?><rows>";
    for account in accounts:
        content += "<row id='" + account[0] + "'><cell><![CDATA[]]></cell><cell>" \
                    "<![CDATA[" + account[0] + "]]></cell><cell><![CDATA[" + account[1] + "]]></cell>" \
                    "<cell><![CDATA[" + account[2] + "]]></cell><cell><![CDATA[" + str(account[4]) + "]]></cell></row>"
    content += "</rows>"
    resp = make_response(content)
    resp.headers['Content-Type'] = 'application/xml'
    return resp


@admin_bp.route('/admin/projects', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_projects():
    return render_template("admin/projects.html")


@admin_bp.route('/admin/list_projects', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_list_projects():
    projects = list_projects()
    content = "<?xml version='1.0' encoding='utf-8' ?><rows>"
    for project in projects:
        content += "<row id='"+str(project[0])+"'><cell><![CDATA["+str(project[0])+"]]></cell><cell><![CDATA["+str(project[1])+"]]></cell>" \
                   "<cell><![CDATA["+str(project[2])+"]]></cell><cell><![CDATA["+str(project[3])+"]]></cell>" \
                   "<cell><![CDATA["+str(project[4])+"]]></cell><cell><![CDATA["+str(project[2])+"]]></cell></row>"

    content += "</rows>"

    resp = make_response(content)
    resp.headers['Content-Type'] = 'application/xml'
    return resp


@admin_bp.route('/admin/settings', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_settings():
    return render_template("admin/settings.html")

@admin_bp.route('/admin/statistics', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_statistics():
    return render_template("admin/statistics.html")

@admin_bp.route('/admin/del_res_acc', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_del_res_acc():
    accounts = request.args.post('accounts')
    delete_res_accounts(accounts)
    return 0

@admin_bp.route('/admin/clearall', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def admin_clear():
    clear_session()
    return 0

@admin_bp.route('/admin/update_password', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def update_password():
    delete_all()
    return 0

@admin_bp.route('/admin/passwd_download', methods = ['GET','POST'])
@login_required
@admin_role.require(401)
def download_passwords():
    return send_file(Config.data_dir+"/passwords.csv", as_attachment=True)
 


def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() ==  'csv'


@admin_bp.route('/admin/upload_users', methods = ['POST'])
@login_required
@admin_role.require(401)
def upload_users():
    if request.method == 'POST':
        # check if the post request has the file part
        if 'file' not in request.files:
            flash('No file part')
            return redirect(request.url)
        file = request.files['file']
      
        # If the user does not select a file, the browser submits an
        # empty file without a filename.
        if file.filename == '':
            flash('No file selected')
            return redirect(request.url)
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(os.path.join(Config.data_dir, filename))
            users = import_reservations(os.path.join(Config.data_dir, filename))
            passwords = gen_passwords(len(users))
            model_base.create_reservations(np.hstack((users,passwords)))
            model_base.create_bc_passwords(np.hstack((users[:,0].reshape(-1,1).reshape(-1,1), passwords[:,2].reshape(-1,1))))
            add_atheos_users(np.hstack((users[:,0].reshape(-1,1),passwords[:,2].reshape(-1,1))), Config.atheos_dir+"/data/users.json")
            with open(os.path.join(Config.data_dir, "passwords.csv"), 'w') as f:
                csv.writer(f).writerows(np.hstack((users[:,:3], passwords[:,0].reshape(-1,1))))
            return send_file(Config.data_dir+"/passwords.csv", as_attachment=True)
    return 0



@admin_bp.route('/admin/create_projects', methods = ['POST'])
@login_required
@admin_role.require(401)
def create_projects():
    users = request.form.getlist('users[]')
    rand = request.form.get('random')
    lang =request.form.get('lang')
    test_name = request.form.get('test_name')
    desc = request.form.get('description')
    if desc is None:
        desc = ""
    
    exercises = model_base.getexercises(isexam=1,  lang=lang)
    exercise_ids = [exercise[0] for exercise in exercises]
    print(len(users), exercise_ids)
    
    if rand:
        projects = create_random_projects(len(users),exercise_ids)
        users = np.hstack((np.array(users).reshape(-1,1),np.array(projects).reshape(-1,1)))
      
        model_base.create_projects(users, lang, test_name, desc)
        prj_dirs = []
        for project in projects:
            prj_dirs.append(model_base.getexercisefolder(project, isexam=1)[0])
        user_projects = np.hstack((users[:,0].reshape(-1,1),np.array(prj_dirs).reshape(-1,1)))
        create_prj_dirs(Config.data_dir, Config.users_dir, user_projects)
        update_atheos_projects(user_projects, Config.atheos_dir+"/data/projects.db.json", Config.users_dir)
        restrict_atheos_acl(Config.atheos_dir+"/data/users.json",user_projects,Config.users_dir)
    return ""


@admin_bp.route('/admin/update_project', methods = ['POST'])
@login_required
@admin_role.require(401)
def update_project():
      
    prj_id = request.form.get('id')
    exercise = request.form.get('exercise')
    users = [request.form.get('user')]
    project = model_base.getproject(users[0])
   
    prj_folder = model_base.getexercisefolder(project['exercise'], isexam=1)[0]
   
    delete_prj_dirs(Config.data_dir, Config.users_dir, [[users[0], prj_folder]])
    model_base.delete_projects([int(prj_id)])
    projects = create_random_projects(len(users),[int(exercise)])
    users = np.hstack((np.array(users).reshape(-1,1),np.array(projects).reshape(-1,1))) 
    model_base.create_projects(users, 'c', 'updated', 'updated')
    prj_dirs = []
    prj_dirs.append(model_base.getexercisefolder(projects[0], isexam=1)[0])
    user_projects = np.hstack((users[:,0].reshape(-1,1),np.array(prj_dirs).reshape(-1,1)))
    create_prj_dirs(Config.data_dir, Config.users_dir, user_projects)
    update_atheos_projects(user_projects, Config.atheos_dir+"/data/projects.db.json", Config.users_dir)
    restrict_atheos_acl(Config.atheos_dir+"/data/users.json",user_projects,Config.users_dir)
    
    return "1"

@admin_bp.route('/admin/exercise_list', methods = ['GET'])
@login_required
@admin_role.require(401)
def exercise_list():
    exercises = model_base.getexercises('c', 1)
    exercise_ids = [exercise[0] for exercise in exercises]
    return   exercise_ids



@admin_bp.route('/admin/clear_session', methods = ['GET'])
@login_required
@admin_role.require(401)
def clear_session():
    model_base.clear_session()
    return "delete  from checks;<br>delete  from checks_test;<br> \
            delete from test_results;<br>delete  from connections;<br> \
            delete  from projects;<br>delete from users;<br> \
            delete from reserved_users;"